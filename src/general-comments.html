<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legg inn generell kommentar</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="${cssPath}" />
  </head>
  <body>
    <h3>Legg inn generell kommentar</h3>
    <div id="rubricContainer">${rubrics}</div>
    <br />
    <div id="btnGroup">
      <button
        id="saveBtn"
        type="button"
        class="btn btn-secondary btn-sm"
        onclick="saveDraft()"
      >
        Lagre utkast
      </button>
      <button type="button" class="btn btn-primary btn-sm">Send inn</button>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script>
      const vscode = acquireVsCodeApi();

      function saveDraft() {
        let rubrics = document.getElementsByClassName("rubric");
        rubrics = Array.from(rubrics);
        rubrics.forEach((rubric) => {
          let children = Array.from(rubric.children);
          let commentBox = children.find((child) =>
            child.classList.contains("commentBox")
          );
          let headerElement = children.find((child) =>
            child.classList.contains("rubricTitle")
          );
          let title = headerElement.innerText.trim();
          let radioGroupName = `radio-${title}`;
          let radioBtns = document.getElementsByName(radioGroupName);
          if (commentBox instanceof HTMLTextAreaElement) {
            let commentText = commentBox.value;
            let checkedBtn = -1;
            for (i = 0; i < radioBtns.length; i++) {
              if (radioBtns[i].checked) {
                checkedBtn = i + 1;
              }
            }
            let rubricInfo = {
              comment: commentText,
              score: checkedBtn,
            };
            localStorage.setItem(title, JSON.stringify(rubricInfo));
            vscode.postMessage({ command: "draftStored" });
          }
        });
      }

      // window.addEventListener("message", (event) => {
      //   //vscode.postMessage({ command: "messageReceived" });
      //   const message = event.data;
      //   if (message.command === "rubricsJson") {
      //     const rubricsJson = message.data;
      //     if (rubricsJson && Array.isArray(rubricsJson.rubrics)) {
      //       loadHTML(rubricsJson);
      //     }
      //   }
      // });

      function loadHTML(rubrics) {
        const rubricsContainer = document.getElementById("rubricContainer");
        rubricsContainer.innerHTML = "";
        rubrics.rubrics = Array.from(rubrics.rubrics);
        rubrics.rubrics.forEach((rubric) => {
          const rubricElement = document.createElement("div");
          rubricElement.classList.add("rubric");
          const rubricTitle = document.createElement("h4");
          rubricTitle.classList.add("rubricTitle");
          rubricTitle.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
            </svg>
            ${rubric.title}`;

          const rubricDescription = document.createElement("p");
          rubricDescription.id = "rubricDescription";
          rubricDescription.textContent = rubric.description;

          const storedDraft = JSON.parse(localStorage.getItem(rubric.title));
          let comment = "";
          if (storedDraft != null) {
            comment = storedDraft.comment;
          }

          let score = -1;
          if (storedDraft != null) {
            score = storedDraft.score;
          }

          const commentBox = document.createElement("textarea");
          commentBox.classList.add("commentBox");
          commentBox.placeholder = "Skriv her.";
          commentBox.cols = "40";
          commentBox.rows = "4";
          commentBox.textContent = comment;

          rubricElement.appendChild(rubricTitle);
          rubricElement.appendChild(rubricDescription);
          rubricElement.appendChild(commentBox);

          const space = document.createElement("br");

          if (rubric.has_score === "true") {
            const radioContainer = document.createElement("div");
            radioContainer.classList.add("flex-container");

            const radioGroup = document.createElement("div");
            radioGroup.classList.add("radio-button-group");

            for (let i = 1; i <= 5; i++) {
              const label = document.createElement("label");
              label.classList.add("container");
              label.textContent = i;

              const radioButton = document.createElement("input");
              radioButton.classList.add("radio-button");
              radioButton.type = "radio";
              radioButton.name = `radio-${rubric.title}`;
              if (i === score) {
                radioButton.checked = true;
              }

              const checkmark = document.createElement("span");
              checkmark.classList.add("checkmark");

              label.appendChild(radioButton);
              label.appendChild(checkmark);
              radioGroup.appendChild(label);
            }

            radioContainer.appendChild(radioGroup);
            rubricElement.appendChild(radioContainer);
          }
          rubricsContainer.appendChild(rubricElement);
          rubricsContainer.appendChild(space);
        });
      }
    </script>
  </body>
</html>
